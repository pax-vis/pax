<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<script src="//d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Karla:400,700&display=swap" rel="stylesheet">
	<style> 
		body {
			font-family: 'Karla', sans-serif;
		}
		div.tooltip { 
    		position: absolute;     
    		text-align: left;     
    		width: auto;          
    		max-width: 300px;
    		height: auto;   
    		padding: 10px;       
    		font: 12px sans-serif;    
    		background: lightsteelblue; 
    		border: 0px;    
    		border-radius: 3px;     
    		pointer-events: none;     
	}

	.inactive {
		color: lightgrey;
	}

	.axis .domain, .axis .tick line  {
		stroke: transparent;
	}
	</style>
</head>
<body> 	
<div class="container-fluid">

	<div class="row">
		<div class="col-md-3">
			<h2 style="margin-top: 50px">Back and forth in Peace negotiations</h2>
			<p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. Ideally, a Peace Process has steady progress towards sustainable peace <span><svg height="12px" width="20px"><path fill="transparent" stroke="#0075FF" stroke-width="2" d="M 1 1 C 10 1, 10 10, 20 10"></path></svg></span>, indicated by a blue trend downwards over time. <br>In reality, processes often also go backwards <span><svg height="12px" width="20px"><path fill="transparent" stroke="#FF3B00" stroke-width="2" d="M 1 11 C 10 11, 10 1, 20 1"></path></svg></span>, meaning that once established agreements have to be re-negotiated (please re-phrase)</p>
			<p style="color: lightgrey;">Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>
		</div>
		<div class="col-md-9 offset-md-3" style="padding-top: 50px; position: fixed">
			<div class="row">
				<div class="col-md-12">
					<div id="chart"></div>
				</div>
			</div>
			<div class="row" id="details" style="border-top: 1px solid lightgrey; padding-top: 10px; margin-top: 10px; min-height: 100px">
				<div class="col-md-3"><small>Peace Process</small><br><span class="ProcessName"><span class="inactive">Click on line to select process</span></span></div>
				<div class="col-md-6"><small>Agreement</small><br><span class="Agreement"><span class="inactive">Hover circle to select agreement</span></span></div>
			</div>
			<div class="row">
				<div id="overview" style="width: 100%"></div>
			</div>
		</div>
	</div>
</div>
<script>
'use strict'
var parseTime = d3.timeParse("%d/%m/%Y");
var width = document.getElementById('chart').clientWidth
var margin = 150
var height = 370
var fixed = null

var sequence = [
	{"key": "Cea",		"name": ["Ceasefire","related"],					"color": d3.rgb(241,80,31,.8),		'position': 1},
	{"key": "Pre",	 	"name": ["Pre-negotiation","process"],				"color": d3.rgb(251,173,68,.8),		'position': 2},
	{"key": "SubPar",	"name": ["Partial","Framework-substantive"],		"color": d3.rgb(252,202,70,.8),		'position': 3},
	{"key": "SubComp",	"name": ["Comprehensive","Framework-substantive"],	"color": d3.rgb(172,176,140,.8),	'position': 4},
	{"key": "Imp",		"name": ["Implementation","Renegotiation/Renewal"],	"color": d3.rgb(74,144,226,.8),		'position': 5},
	{"key": "Ren",		"name": [],											"color": d3.rgb(74,144,226,8),		'position': 5},
]

queue()
  .defer(d3.csv, 'agreements-small.csv')
  .await(init);

function init(error,pax) {

	//Filter & Sort agreement data
	pax = pax.filter((d,i) => d.Stage !== "Oth")
	pax.sort(function(a,b){
		function getDate(d) {return parseTime(d.Date)}
		return getDate(a) - getDate(b)
	})

	//Create Objects for Agreements in the same process
	var processes = {}
	pax.forEach(function(agreement){
		if (typeof sequence.find(x => x.key == agreement.Stage) !== 'undefined') sequence.find(x => x.key == agreement.Stage).count++
	 	var name = agreement["PPName"]
	 	if(typeof  processes[name] === 'undefined') processes[name] = []
	 	processes[name].push(agreement)
	})

	console.log(processes)

	//create canvas
	var svg = d3.select("#chart")
		.append("svg")
			.attr("viewBox","0 0 "+width+" "+height)
			.attr("preserveAspectRatio","xMidYMid meet")
	
	//Scales & Axes
	var scaleColor = d3.scaleLinear()
		.domain([-350,0,350])
		.range([d3.rgb("#FF3B00"), d3.rgb("#555555"), d3.rgb("#0075FF")])
	var scaleY = d3.scaleLinear()
		.domain([1,sequence.length-1])
		.range([20,350])
	var scaleX = d3.scaleTime()
		.domain(d3.extent(pax,function(d){return parseTime(d.Date)}))
		.range([0,width-margin-10])
    var xAxis = d3.axisTop(scaleX);
    var years = svg
    	.append("g")
    	.attr("class", "axis axis--x")
    	.attr("transform", "translate(0,20)")
    	.call(xAxis);

    //legend
	var legend = svg.append("g")
		.attr("class","lines")
		.selectAll("g")
		.data(sequence).enter()
		.append("text")
			.attr("y",d=>scaleY(d.position) -15)
			.attr("font-size","10pt")
			.attr("text-anchor","start")
			.selectAll("tspan").data(d=>d.name).enter().append("tspan")
				.text(d=>d)
				.attr("x",width-margin)
				.attr("dy","10pt")

	//compute line segments
	var segment = function(d,i,scale) {
		if(i < processes[d.PPName].length-1) {
			var start = {
				"x": Math.round(scale(parseTime(d.Date))),
				"y": scaleY(sequence.find(x=>x.key == d.Stage).position)
			}
			var stop = {
				"x": Math.round(scale(parseTime(processes[d.PPName][i+1].Date))),
				"y": scaleY(sequence.find(x=>x.key == processes[d.PPName][i+1].Stage).position)
			}
			var distance = (stop.x - start.x) / 1.5
			return "M "+start.x+" "+start.y+" C "+(start.x + distance)+" "+start.y+", "+(stop.x - distance)+" "+stop.y+", "+stop.x+" "+stop.y
		}
	}

	//draw paths for processes
	svg.append("clipPath")
		.attr("id", "ellipse-clip")
		.append("rect")
			.attr("x", 0)
			.attr("y", 0)
			.attr("width", width-margin-10)
			.attr("height", height);  //clipPath for zoomed processes
	
	var processContainer = svg.append("g")
		.attr("class","processes")
		.attr("clip-path", "url(#ellipse-clip)")
		.attr("pointer-events", "all")
		.on("click",d=>{console.log(d)})

	var process = processContainer.selectAll("g")
		.data(Object.entries(processes)).enter()
		.append("g")
			.attr("class",d=>"PP-"+d[1][0].PP)
			.selectAll("path").data(d=>d[1])
			.enter()
			.append("path")
				.attr("pointer-events","all")
				.attr("fill-opacity", 0)
				.attr("stroke-width", 1)
				.attr("stroke-opacity", .2)
				.attr("d",(d,i)=>segment(d,i,scaleX))
				.attr("stroke", (d,i)=>{
					if(i < processes[d.PPName].length-1) {
						var tendency = scaleY(sequence.find(x=>x.key == processes[d.PPName][i+1].Stage).position) - scaleY(sequence.find(x=>x.key == d.Stage).position)
						return scaleColor(tendency)
					}
				})

	//draw circles for each agreement
	var circles = svg.append("g").attr("class","circles").selectAll("circle").data(pax).enter().append("circle")
		.attr("class",d=>"PP-"+d.PP)
		.attr("cx",d=>Math.round(scaleX(parseTime(d.Date))))
		.attr("cy",d=>scaleY(sequence.find(x=>x.key == d.Stage).position))
		.attr("r",5)
		.attr("stroke","black")
		.attr("stroke-width",1)
		.attr("fill","white")
		.attr("fill-opacity",.5)
		.attr("opacity",0)
		.attr("pointer-events", "none")
		.on("mouseover",function(d) {
			d3.select(this)
				.transition()
				.duration(50)
				.attr("r",10)
			d3.select(".Agreement")
				.html("<strong>"+d.Date+":</strong> "+d.Agt)
		})
		.on("mouseout",function(d) {
			d3.select(this)
				.transition()
				.duration(50)
				.attr("r",5)
			d3.select(".Agreement")
				.html('<span class="inactive">Hover circle to select agreement</span>')
		})

	/*//Idealized process line
	var ideal = [{"Date": "01/01/1990", "Stage": "Cea"},{"Date": "01/01/1995", "Stage": "Pre"},{"Date": "01/01/2000", "Stage": "SubPar"},{"Date": "01/01/2005", "Stage": "SubComp"},{"Date": "01/01/2010", "Stage": "Ren"},{"Date": "01/01/2019", "Stage": "Ren"}]
	svg.append("g").attr("class","ideal").selectAll("path").data(ideal).enter().append("path").attr("fill-opacity", 0).attr("stroke-width", 2).attr("stroke-opacity", 1).attr("stroke", "#0075FF")
		.attr("d",function(d,i){
			if(i <ideal.length-1) {
				var start = {
					"x": Math.round(scaleX(parseTime(d.Date))),
					"y": scaleY(sequence.find(x=>x.key == d.Stage).position)
				}
				var stop = {
					"x": Math.round(scaleX(parseTime(ideal[i+1].Date))),
					"y": scaleY(sequence.find(x=>x.key == ideal[i+1].Stage).position)
				}
				var distance = (stop.x - start.x) / 1.5
				return "M "+start.x+" "+start.y+" C "+(start.x + distance)+" "+start.y+", "+(stop.x - distance)+" "+stop.y+", "+stop.x+" "+stop.y
			}
		})*/

	var overview = d3.select("#overview")
		.append("svg")
			.attr("viewBox","0 0 "+width+" 500")
			.attr("preserveAspectRatio","xMidYMid meet")

	overview.append("g")
		.selectAll("line")
		.data(Object.values(processes))
		.enter()
		.append("line")
    		.attr("stroke",d3.rgb(0,0,0,1))
    		.attr("stroke-width",.2)
    		.attr("x1",d=> Math.round(scaleX(parseTime(d[0].Date))))
    		.attr("x2",d=> Math.round(scaleX(parseTime(d[d.length-1].Date))))
    		.attr("y1",(d,i) => (i *1))
    		.attr("y2",(d,i) => (i *1))

    //INTERACTION
	var zoom = d3.zoom()
		.scaleExtent([1, Infinity])
		.translateExtent([[0, 0], [width-margin, height]])
		.extent([[0, 0], [width-margin, height]])
		.on("zoom", zoomed);
    svg.call(zoom)

    function zoomed(){
		var zoomScale = d3.event.transform.rescaleX(scaleX)
		years.call(xAxis.scale(zoomScale));
		process.attr("d",(d,i)=>segment(d,i,zoomScale))
		circles.attr("cx",d=>Math.round(zoomScale(parseTime(d.Date))))
	};

	document.onkeydown = function(e) {
		if(e.key == "Escape") {
			exitProcess();
		}
	}

	process
		.on("mouseover",d=>highlightProcess(d))
		.on("click",d=>fixed ? exitProcess(d) : enterProcess(d))
		.on("mouseout",d=>deHighlightProcess(d))

	/*svg.on("click",function(){
		if(fixed) exitProcess();
	})*/

	var highlightProcess = function(d) {
		if(!fixed) {
			process.attr("stroke-opacity",0.05)
			d3.selectAll("g.PP-"+d.PP+" path").attr("stroke-opacity",1).attr("stroke-width",3)
			d3.selectAll(".ideal path").attr("stroke-opacity",0.1)
			d3.select("#details .ProcessName").html(d.PPName)
		}
	}

	var deHighlightProcess = function(d) {
		if(!fixed) {
			process.attr("stroke-opacity", .2).attr("stroke-width",1)
			d3.selectAll(".ideal path").attr("stroke-opacity",1)
			d3.select("#details .ProcessName").html('<span class="inactive">Click on line to select process</span>')
		}
	}

	var enterProcess = function(d) {
		fixed = d.PPName
		d3.selectAll("circle.PP-"+d.PP).attr("opacity",.7).attr("pointer-events", "all")
		process.attr("pointer-events","none")

		var d0 = parseTime(processes[d.PPName][0].Date)
		var d1 = parseTime(processes[d.PPName][processes[d.PPName].length-1].Date)

		svg.call(zoom).transition().duration(1500)
      		.call(zoom.transform,
      			d3.zoomIdentity
       			  .scale( (width - margin - 60) / (scaleX(d1) - scaleX(d0)) )
       			  .translate(30-scaleX(d0), 0));
	}

	var exitProcess = function() {
		fixed = null;
		svg.call(zoom).transition().duration(1500)
      		.call(zoom.transform,
      			d3.zoomIdentity
       			  .scale(1)
       			  .translate(0, 0)
       		);
		circles.attr("opacity",0).attr("pointer-events", "none")
		process.attr("stroke-opacity", .2).attr("stroke-width",1)
	}
}
</script>
</body>